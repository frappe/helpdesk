{% extends 'templates/web.html'%}

{% block page_content %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">
{% if frappe.session.user != "Guest" %}
<div class="main-container">
    <div class="d-flex mb-2">
        <div class="mr-auto">
            <h2>Your Tickets</h2>
        </div>
        <div class="d-flex">
            <div class="dropdown mr-2">
                <a id="dropdownTitle"class="btn btn-secondary btn-sm dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Show All
                </a>
                <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                    <a class="dropdown-item">Show All</a>
                    <a class="dropdown-item">Show Open</a>
                    <a class="dropdown-item">Show Resolved</a>
                </div>
            </div>
            <div>
                <button class="btn btn-sm btn-primary" onclick="window.location='/support/tickets/new'">New Ticket</button>
            </div>
        </div>
    </div>
    <div class="frappe-card bg-white">
        <div id="ticketListContainer" class="list-group-flush tickets-container">
        </div>
    </div>
</div>
{% else %}
<div class="alert alert-warning">
    <p>
        Please login to be able to create tickets.
    </p>
    <p>
        If you don't already have an account, you can <a href="/login#signup">sign up for a new account</a>.
    </p>
    <a class="btn btn-primary" href="/login">Login to continue</a>
</div>
{% endif %}
<script>
    let allTickets = [];

    frappe.ready(function() {
        frappe.call({
            btn: this,
            method: "helpdesk.helpdesk.doctype.ticket.ticket.get_all_user_tickets",
            callback: function(r) {
                allTickets = r.message;
                showTickets();
            }
        })

        $(".dropdown-menu a").click(function(){
            var selText = $(this).text();
            showTickets(filter=selText);
            let selectedOption = ""
            if(selText == "Show Resolved") {
                selectedOption = "Show Resolved";
            } else if(selText == "Show Open") {
                selectedOption = "Show Open";
            } else {
                selectedOption = "Show All";
            }
            $("#dropdownTitle").html(selectedOption);
        });
    })

    function showTickets(filter="Show All") {
        let listContainer = $("#ticketListContainer");
        listContainer.empty();

        for(var i = 0; i < allTickets.length; i++) {
            let ticket = allTickets[i];
            let isResolved = (ticket.status == "Resolved");
            
            if(filter == "Show Open" && isResolved) continue;
            if(filter == "Show Resolved" && !isResolved) continue;

            listContainer.append(`
                <a href="/${ticket.route}" class="list-group-item list-group-item-action rounded">
                    <div class="float-right">
                        <span class="indicator-pill ${isResolved ? "green" : "orange"} filterable ellipsis">${isResolved ? "Resolved" : "Open"}</span>
                    </div>
                    <div class="ticket-card-main">
                        <h3>${ticket.subject}</h3>
                        <span class="">${ticket.creation}</span>
                    </div>
                </a>    
            `);
        }
    }

</script>
{% endblock %}